<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inspección Fitosanitaria</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --primary-color: #2c5234;
            --secondary-color: #4CAF50;
            --background-color: #f7fafc;
            --text-color: #2d3748;
            --light-gray: #e2e8f0;
            --dark-gray: #a0aec0;
            --border-radius: 8px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* --- Login/Registro --- */
        #auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100vh;
            background-color: var(--background-color);
        }

        .auth-card {
            background-color: #fff;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s ease-out forwards;
        }

        .auth-card h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 24px;
        }

        .auth-card input {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .auth-card input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .auth-card button {
            width: 100%;
            padding: 12px;
            border: none;
            background-color: var(--primary-color);
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        .auth-card button:hover {
            background-color: #22432a;
            transform: translateY(-2px);
        }

        .auth-card .switch-auth {
            margin-top: 16px;
            font-size: 0.9rem;
            color: var(--dark-gray);
            cursor: pointer;
            transition: color 0.3s;
        }

        .auth-card .switch-auth:hover {
            color: var(--primary-color);
        }
        
        .auth-card .error-message {
            color: red;
            margin-top: 10px;
            font-size: 0.9rem;
            display: none;
            animation: shake 0.5s;
        }
        
        /* --- Layout de la Aplicación --- */
        .app-layout {
            display: none;
            width: 100%;
        }
        
        .sidebar {
            width: 250px;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            position: fixed;
            height: 100%;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
        }

        .logo {
            padding: 24px;
            text-align: center;
            border-bottom: 1px solid var(--light-gray);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            background-color: #f7fafc;
        }

        .main-menu {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }

        .main-menu li {
            position: relative;
        }

        .main-menu a {
            display: block;
            padding: 16px 24px;
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s, transform 0.2s;
            display: flex;
            align-items: center;
        }

        .main-menu a:hover {
            background-color: var(--light-gray);
            color: var(--primary-color);
            transform: translateX(5px);
        }

        .main-menu a.active {
            background-color: var(--primary-color);
            color: #fff;
            font-weight: 500;
            border-left: 4px solid var(--secondary-color);
        }

        .main-menu li.restricted {
            display: none;
        }
        
        .main-menu .has-submenu > a::after {
            content: '+';
            font-size: 1.2rem;
            margin-left: auto;
            transition: transform 0.3s;
        }
        
        .main-menu .has-submenu.open > a::after {
            transform: rotate(45deg);
        }

        .submenu {
            list-style: none;
            padding: 0;
            margin: 0;
            background-color: #f0f4f8;
            display: none;
            overflow: hidden;
        }

        .submenu a {
            padding-left: 48px;
            font-size: 0.9rem;
        }
        
        .footer {
            padding: 16px;
            text-align: center;
            border-top: 1px solid var(--light-gray);
            background-color: #f7fafc;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 24px;
            flex-grow: 1;
            transition: margin-left 0.3s ease-in-out;
        }
        
        header {
            display: flex;
            align-items: center;
            padding: 16px 24px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 999;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .logout-button {
            padding: 8px 16px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            background-color: #fff;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .logout-button:hover {
            background-color: var(--light-gray);
            color: var(--primary-color);
        }
        
        .content-section {
            display: none;
            padding: 24px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s ease-out forwards;
        }

        .content-section.active {
            display: block;
        }
        
        h1, h2 {
            color: var(--primary-color);
        }

        p {
            margin-bottom: 1rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group input, .form-group select {
            width: calc(100% - 24px);
            padding: 12px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            text-decoration: none;
            display: inline-block;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        
        .btn-primary:hover {
            background-color: #22432a;
            transform: translateY(-2px);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
        }
        
        .data-table th, .data-table td {
            border: 1px solid var(--light-gray);
            padding: 12px;
            text-align: left;
        }
        
        .data-table th {
            background-color: #f0f4f8;
            font-weight: 600;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .data-table tr {
            transition: background-color 0.3s;
        }

        .data-table tr:hover {
            background-color: #f0f4f8;
        }

        .report-section {
            margin-top: 24px;
            padding: 16px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
        }

        /* Estilos para el gráfico */
        #chart-container {
            margin-top: 24px;
            padding: 16px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            text-align: center;
        }
        #incidence-chart {
            width: 100%;
            max-width: 600px;
            height: 300px;
            margin: auto;
        }

        /* Modal para el reporte */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            animation: fadeIn 0.3s ease-in-out;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            animation: slideIn 0.5s ease-out;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-button:hover, .close-button:focus {
            color: #000;
            text-decoration: none;
        }

        /* Keyframe Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-250px);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }
            
            .app-layout {
                flex-direction: column;
            }

            .menu-toggle {
                display: block;
                font-size: 1.5rem;
                cursor: pointer;
                margin-right: 16px;
                color: var(--text-color);
            }
            
            header {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <!-- Contenedor de Autenticación (se muestra por defecto) -->
    <div id="auth-container">
        <div class="auth-card">
            <h1>Iniciar Sesión</h1>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Correo Electrónico" required>
                <input type="password" id="login-password" placeholder="Contraseña" required>
                <button type="submit">Entrar</button>
            </form>
            <p class="error-message" id="login-error-message">Credenciales incorrectas.</p>
            <p class="switch-auth" id="show-register">¿No tienes una cuenta? Regístrate</p>
        </div>

        <div class="auth-card" id="register-card" style="display:none;">
            <h1>Registrarse</h1>
            <form id="register-form">
                <input type="email" id="register-email" placeholder="Correo Electrónico" required>
                <input type="password" id="register-password" placeholder="Contraseña" required>
                <select id="register-role" style="width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid var(--light-gray); border-radius: var(--border-radius);">
                    <option value="tecnico">Técnico</option>
                    <option value="administrador">Administrador</option>
                </select>
                <button type="submit">Registrarme</button>
            </form>
            <p class="error-message" id="register-error-message">Error en el registro. Inténtalo de nuevo.</p>
            <p class="switch-auth" id="show-login">¿Ya tienes una cuenta? Iniciar Sesión</p>
        </div>
    </div>
    
    <!-- Contenedor Principal de la Aplicación (se oculta por defecto) -->
    <div class="app-layout" id="app-layout">
        <!-- Barra Lateral (Sidebar) -->
        <aside class="sidebar">
            <div class="logo">ICA</div>
            <nav>
                <ul class="main-menu">
                    <li class="has-submenu">
                        <a href="#" data-target="gestion-informacion">
                            Gestión de Información
                        </a>
                        <ul class="submenu">
                            <li id="menu-productores"><a href="#" data-target="gestion-productores">Productores</a></li>
                            <li id="menu-predios"><a href="#" data-target="gestion-predios">Predios</a></li>
                            <li id="menu-tecnicos"><a href="#" data-target="gestion-tecnicos">Técnicos</a></li>
                        </ul>
                    </li>
                    <li id="menu-inspecciones"><a href="#" data-target="registro-inspecciones">Registro de Inspecciones</a></li>
                    <li id="menu-seguimiento"><a href="#" data-target="seguimiento">Seguimiento de Inspecciones</a></li>
                    <li id="menu-reportes"><a href="#" data-target="reportes">Reportes e Informes</a></li>
                    <li id="menu-historial"><a href="#" data-target="historial">Consulta de Historial</a></li>
                </ul>
            </nav>
            <div class="footer">
                <span id="user-display"></span>
            </div>
        </aside>

        <!-- Contenido Principal -->
        <div class="main-content">
            <header>
                <div class="menu-toggle">☰</div>
                <div class="header-title" id="page-title">Bienvenido</div>
                <button class="logout-button" id="logout-button">Cerrar Sesión</button>
            </header>
            
            <main>
                <div id="bienvenido" class="content-section active">
                    <h1>Bienvenido al Sistema de Inspección Fitosanitaria</h1>
                    <p>Este sistema permite el registro, la gestión y el seguimiento de las inspecciones fitosanitarias de predios de producción de vegetales, mejorando la eficiencia y la trazabilidad del proceso para el ICA y los técnicos.</p>
                </div>

                <div id="gestion-informacion" class="content-section">
                    <h1>Gestión de Información</h1>
                    <p>Aquí puede gestionar la información de productores, predios y técnicos.</p>
                </div>

                <div id="gestion-productores" class="content-section">
                    <h1>Gestión de Productores</h1>
                    <p>Módulo para la gestión (CRUD) de la información de los productores.</p>
                    <hr>
                    <form id="producer-form">
                        <h2>Crear/Editar Productor</h2>
                        <div class="form-group">
                            <label for="producer-name">Nombre Completo:</label>
                            <input type="text" id="producer-name" required>
                        </div>
                        <div class="form-group">
                            <label for="producer-id">Cédula/ID:</label>
                            <input type="text" id="producer-id" required>
                        </div>
                        <div class="form-group">
                            <label for="producer-phone">Teléfono:</label>
                            <input type="tel" id="producer-phone">
                        </div>
                        <div class="form-group">
                            <label for="producer-email">Correo:</label>
                            <input type="email" id="producer-email">
                        </div>
                        <button type="submit" class="btn-primary">Guardar Productor</button>
                    </form>
                    
                    <hr>
                    <h2>Listado de Productores</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Teléfono</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productores-list">
                            <!-- Los datos se cargarán aquí -->
                        </tbody>
                    </table>
                </div>

                <div id="gestion-predios" class="content-section">
                    <h1>Gestión de Predios</h1>
                    <p>Módulo para la gestión (CRUD) de la información de los predios.</p>
                    <hr>
                    <form id="predio-form">
                        <h2>Crear/Editar Predio</h2>
                        <div class="form-group">
                            <label for="predio-name">Nombre del Predio:</label>
                            <input type="text" id="predio-name" required>
                        </div>
                        <div class="form-group">
                            <label for="predio-location">Ubicación:</label>
                            <input type="text" id="predio-location" required>
                        </div>
                        <div class="form-group">
                            <label for="predio-extension">Extensión (ha):</label>
                            <input type="number" id="predio-extension" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="predio-producer">Productor:</label>
                            <select id="predio-producer">
                                <option value="">Seleccione un productor</option>
                                <!-- Aquí se cargarían los productores del sistema -->
                            </select>
                        </div>
                        <button type="submit" class="btn-primary">Guardar Predio</button>
                    </form>
                    
                    <hr>
                    <h2>Listado de Predios</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Ubicación</th>
                                <th>Extensión (ha)</th>
                                <th>Productor</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="predios-list">
                            <!-- Los datos se cargarán aquí -->
                        </tbody>
                    </table>
                </div>

                <div id="gestion-tecnicos" class="content-section">
                    <h1>Gestión de Técnicos</h1>
                    <p>Módulo para la gestión (CRUD) de la información de los técnicos.</p>
                    <hr>
                    <form id="tecnico-form">
                        <h2>Crear/Editar Técnico</h2>
                        <div class="form-group">
                            <label for="tecnico-name">Nombre Completo:</label>
                            <input type="text" id="tecnico-name" required>
                        </div>
                        <div class="form-group">
                            <label for="tecnico-prof-id">Tarjeta Profesional:</label>
                            <input type="text" id="tecnico-prof-id" required>
                        </div>
                        <div class="form-group">
                            <label for="tecnico-phone">Teléfono:</label>
                            <input type="tel" id="tecnico-phone">
                        </div>
                        <div class="form-group">
                            <label for="tecnico-email">Correo:</label>
                            <input type="email" id="tecnico-email" required>
                        </div>
                        <button type="submit" class="btn-primary">Guardar Técnico</button>
                    </form>

                    <hr>
                    <h2>Listado de Técnicos</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Tarjeta Profesional</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tecnicos-list">
                            <!-- Los datos se cargarán aquí -->
                        </tbody>
                    </table>
                </div>

                <div id="registro-inspecciones" class="content-section">
                    <h1>Registro de Inspecciones</h1>
                    <p>Formulario para el registro de una nueva inspección, incluyendo el conteo de plantas y plagas.</p>
                    <hr>
                    <form id="inspeccion-form">
                        <h2>Nueva Inspección</h2>
                        <div class="form-group">
                            <label for="inspeccion-predio">Predio:</label>
                            <select id="inspeccion-predio" required>
                                <option value="">Seleccione un predio</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="inspeccion-date">Fecha de Inspección:</label>
                            <input type="date" id="inspeccion-date" required>
                        </div>
                        <div class="form-group">
                            <label for="inspeccion-cultivo">Cultivo:</label>
                            <input type="text" id="inspeccion-cultivo" placeholder="Ej: Aguacate Hass">
                        </div>
                        <div class="form-group">
                            <label for="plantas-totales">Plantas Totales:</label>
                            <input type="number" id="plantas-totales" required>
                        </div>
                        <div class="form-group">
                            <label for="plantas-afectadas">Plantas Afectadas:</label>
                            <input type="number" id="plantas-afectadas" required>
                        </div>
                        <div class="form-group">
                            <label for="plaga-name">Nombre de la Plaga:</label>
                            <input type="text" id="plaga-name" placeholder="Ej: Ácaro de la yema">
                        </div>
                        <button type="submit" class="btn-primary">Registrar Inspección</button>
                    </form>
                </div>

                <div id="seguimiento" class="content-section">
                    <h1>Seguimiento de Inspecciones</h1>
                    <p>Seleccione un predio para ver el historial de incidencia de plagas y generar un reporte.</p>
                    <hr>
                    <div class="form-group">
                        <label for="seguimiento-predio">Seleccionar Predio:</label>
                        <select id="seguimiento-predio">
                            <option value="">Seleccione un predio</option>
                        </select>
                    </div>
                    <div id="seguimiento-content" style="display:none;">
                        <div id="chart-container">
                            <h2>Evolución de la Incidencia de Plagas</h2>
                            <canvas id="incidence-chart"></canvas>
                        </div>
                        <h2 style="margin-top: 24px;">Historial de Incidencia de Plagas</h2>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Cultivo</th>
                                    <th>Plantas Totales</th>
                                    <th>Plantas Afectadas</th>
                                    <th>Incidencia (%)</th>
                                </tr>
                            </thead>
                            <tbody id="seguimiento-list">
                                <!-- Datos de seguimiento se cargarán aquí -->
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 24px;">
                            <button id="generate-report-btn" class="btn-primary">Generar Reporte Detallado</button>
                        </div>
                    </div>
                    <div id="report-modal" class="modal">
                        <div class="modal-content">
                            <span id="close-report-modal" class="close-button">&times;</span>
                            <h2>Reporte de Inspecciones</h2>
                            <div id="report-content"></div>
                        </div>
                    </div>
                </div>

                <div id="reportes" class="content-section">
                    <h1>Reportes e Informes</h1>
                    <p>Módulo para la generación de informes detallados y automatizados.</p>
                    <hr>
                    <p>Aquí se podría seleccionar un predio y un rango de fechas para generar un reporte detallado en formato PDF o de hoja de cálculo.</p>
                    <button class="btn-primary">Generar Reporte</button>
                </div>

                <div id="historial" class="content-section">
                    <h1>Consulta de Historial</h1>
                    <p>Acceso al historial de inspecciones por predio para consulta.</p>
                    <hr>
                    <div class="form-group">
                        <label for="filter-predio">Filtrar por Predio:</label>
                        <select id="filter-predio">
                            <option value="">Todos los predios</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-tecnico">Filtrar por Técnico:</label>
                        <select id="filter-tecnico">
                            <option value="">Todos los técnicos</option>
                        </select>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Predio</th>
                                <th>Técnico</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="historial-list">
                            <!-- Los datos se cargarán aquí -->
                        </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Datos de usuarios y permisos
            const users = {
                "admin@ica.com": { password: "adminpassword", role: "administrador" },
                "tecnico@ica.com": { password: "tecnicopassword", role: "tecnico" }
            };

            // Simulación de datos de la "base de datos"
            const db = {
                productores: [
                    { id: "101010", nombre: "Juan Pérez", telefono: "3101234567", correo: "juan.perez@email.com" },
                    { id: "202020", nombre: "Ana Gómez", telefono: "3209876543", correo: "ana.gomez@email.com" }
                ],
                predios: [
                    { nombre: "Finca El Roble", ubicacion: "Vereda La Palma", extension: 50, productor: "Juan Pérez" },
                    { nombre: "Hacienda Las Rosas", ubicacion: "Vereda El Jardín", extension: 120, productor: "Ana Gómez" }
                ],
                tecnicos: [
                    { id: "T-001", nombre: "María Rodríguez", tarjeta: "TP-2023-01", telefono: "3001112233", correo: "maria.rodriguez@ica.gov.co" },
                    { id: "T-002", nombre: "Luis Fernández", tarjeta: "TP-2023-02", telefono: "3004445566", correo: "luis.fernandez@ica.gov.co" }
                ],
                inspecciones: [
                    { predio: "Finca El Roble", fecha: "2023-10-15", tecnico: "María Rodríguez", cultivo: "Aguacate Hass", plantas_totales: 500, plantas_afectadas: 25, plaga: "Ácaro de la yema" },
                    { predio: "Hacienda Las Rosas", fecha: "2023-10-16", tecnico: "Luis Fernández", cultivo: "Naranjas Valencia", plantas_totales: 1200, plantas_afectadas: 60, plaga: "Mosca de la fruta" },
                    { predio: "Finca El Roble", fecha: "2023-11-20", tecnico: "María Rodríguez", cultivo: "Aguacate Hass", plantas_totales: 550, plantas_afectadas: 40, plaga: "Ácaro de la yema" },
                    { predio: "Finca El Roble", fecha: "2024-01-25", tecnico: "María Rodríguez", cultivo: "Aguacate Hass", plantas_totales: 600, plantas_afectadas: 30, plaga: "Ácaro de la yema" }
                ]
            };

            let currentUserRole = ''; // Variable para guardar el rol del usuario

            // Lógica de inicio de sesión
            $('#login-form').on('submit', function(e) {
                e.preventDefault();
                const email = $('#login-email').val();
                const password = $('#login-password').val();
                const user = users[email];

                if (user && user.password === password) {
                    currentUserRole = user.role;
                    $('#auth-container').hide();
                    $('#app-layout').css('display', 'flex');
                    $('#user-display').text(`Usuario: ${currentUserRole}`);
                    // Ocultar/mostrar elementos del menú según el rol
                    updateMenuVisibility(currentUserRole);
                    // Cargar datos en las tablas y los select
                    loadData();
                } else {
                    $('#login-error-message').text('Credenciales incorrectas.').show();
                }
            });

            // Lógica de registro (simulado)
            $('#register-form').on('submit', function(e) {
                e.preventDefault();
                const email = $('#register-email').val();
                const password = $('#register-password').val();
                const role = $('#register-role').val();

                if (email in users) {
                    $('#register-error-message').text('El correo ya está registrado.').show();
                } else {
                    users[email] = { password, role };
                    $('#register-error-message').text('Registro exitoso. Ahora puedes iniciar sesión.').show().css('color', 'green');
                    setTimeout(() => {
                        $('#show-login').trigger('click');
                        $('#register-error-message').hide();
                    }, 2000);
                }
            });

            // Lógica de cierre de sesión
            $('#logout-button').on('click', function() {
                $('#app-layout').hide();
                $('#auth-container').show();
                $('#login-form')[0].reset();
                $('#register-form')[0].reset();
                $('.content-section').removeClass('active');
                $('#bienvenido').addClass('active');
                $('#page-title').text('Bienvenido');
            });

            // Manejar cambio entre login y registro
            $('#show-register').on('click', function() {
                $('.auth-card').hide();
                $('#register-card').show();
            });

            $('#show-login').on('click', function() {
                $('.auth-card').hide();
                $('#login-form').parent().show();
            });

            // Función para actualizar la visibilidad del menú según el rol
            function updateMenuVisibility(role) {
                if (role === 'administrador') {
                    $('#menu-productores, #menu-predios, #menu-tecnicos').parent().show();
                } else if (role === 'tecnico') {
                    $('#menu-productores, #menu-predios, #menu-tecnicos').parent().hide();
                }
            }

            // Función principal para cargar y renderizar los datos
            function loadData() {
                renderProductores();
                renderPredios();
                renderTecnicos();
                renderInspeccionSelects();
                renderSeguimientoSelects();
                renderHistorial();
                renderHistorialFilterPredios();
                renderHistorialFilterTecnicos();
            }

            // Funciones de renderizado específicas para cada sección
            function renderProductores() {
                $('#productores-list').empty();
                if (currentUserRole === 'administrador') {
                    db.productores.forEach(p => {
                        const row = `
                            <tr>
                                <td>${p.id}</td>
                                <td>${p.nombre}</td>
                                <td>${p.telefono}</td>
                                <td><a href="#">Editar</a> | <a href="#">Eliminar</a></td>
                            </tr>
                        `;
                        $('#productores-list').append(row);
                    });
                }
            }

            function renderPredios() {
                $('#predios-list').empty();
                if (currentUserRole === 'administrador') {
                    db.predios.forEach(p => {
                        const row = `
                            <tr>
                                <td>${p.nombre}</td>
                                <td>${p.ubicacion}</td>
                                <td>${p.extension}</td>
                                <td>${p.productor}</td>
                                <td><a href="#">Editar</a> | <a href="#">Eliminar</a></td>
                            </tr>
                        `;
                        $('#predios-list').append(row);
                    });
                }
            }

            function renderTecnicos() {
                $('#tecnicos-list').empty();
                if (currentUserRole === 'administrador') {
                    db.tecnicos.forEach(t => {
                        const row = `
                            <tr>
                                <td>${t.id}</td>
                                <td>${t.nombre}</td>
                                <td>${t.tarjeta}</td>
                                <td><a href="#">Editar</a> | <a href="#">Eliminar</a></td>
                            </tr>
                        `;
                        $('#tecnicos-list').append(row);
                    });
                }
            }

            function renderInspeccionSelects() {
                // Rellena el select de productores en el form de predios
                $('#predio-producer').empty().append('<option value="">Seleccione un productor</option>');
                db.productores.forEach(p => {
                    $('#predio-producer').append(`<option value="${p.nombre}">${p.nombre}</option>`);
                });

                // Rellena el select de predios en el form de inspecciones
                $('#inspeccion-predio').empty().append('<option value="">Seleccione un predio</option>');
                db.predios.forEach(p => {
                    $('#inspeccion-predio').append(`<option value="${p.nombre}">${p.nombre}</option>`);
                });
            }

            function renderSeguimientoSelects() {
                // Rellena el select de predios en la sección de seguimiento
                $('#seguimiento-predio').empty().append('<option value="">Seleccione un predio</option>');
                db.predios.forEach(p => {
                    $('#seguimiento-predio').append(`<option value="${p.nombre}">${p.nombre}</option>`);
                });
            }
            
            function renderHistorial(filterPredio = '', filterTecnico = '') {
                $('#historial-list').empty();
                let filteredInspecciones = db.inspecciones;

                if (filterPredio) {
                    filteredInspecciones = filteredInspecciones.filter(i => i.predio === filterPredio);
                }

                if (filterTecnico) {
                    filteredInspecciones = filteredInspecciones.filter(i => i.tecnico === filterTecnico);
                }

                filteredInspecciones.forEach(i => {
                    const row = `
                        <tr>
                            <td>${i.fecha}</td>
                            <td>${i.predio}</td>
                            <td>${i.tecnico}</td>
                            <td><a href="#" class="view-details" data-predio="${i.predio}" data-fecha="${i.fecha}" data-tecnico="${i.tecnico}">Ver Detalles</a></td>
                        </tr>
                    `;
                    $('#historial-list').append(row);
                });
            }

            function renderHistorialFilterPredios() {
                const predios = [...new Set(db.predios.map(p => p.nombre))];
                $('#filter-predio').empty().append('<option value="">Todos los predios</option>');
                predios.forEach(p => {
                    $('#filter-predio').append(`<option value="${p}">${p}</option>`);
                });
            }

            function renderHistorialFilterTecnicos() {
                const tecnicos = [...new Set(db.tecnicos.map(t => t.nombre))];
                $('#filter-tecnico').empty().append('<option value="">Todos los técnicos</option>');
                tecnicos.forEach(t => {
                    $('#filter-tecnico').append(`<option value="${t}">${t}</option>`);
                });
            }

            // Manejar el envío del formulario de Productores
            $('#producer-form').on('submit', function(e) {
                e.preventDefault();
                const newProducer = {
                    id: $('#producer-id').val(),
                    nombre: $('#producer-name').val(),
                    telefono: $('#producer-phone').val(),
                    correo: $('#producer-email').val()
                };
                db.productores.push(newProducer);
                $('#producer-form').append('<p style="color:green;">Productor guardado exitosamente.</p>');
                setTimeout(() => $('#producer-form p').remove(), 2000);
                $('#producer-form')[0].reset();
                loadData();
            });

            // Manejar el envío del formulario de Predios
            $('#predio-form').on('submit', function(e) {
                e.preventDefault();
                const newPredio = {
                    nombre: $('#predio-name').val(),
                    ubicacion: $('#predio-location').val(),
                    extension: $('#predio-extension').val(),
                    productor: $('#predio-producer').val()
                };
                db.predios.push(newPredio);
                $('#predio-form').append('<p style="color:green;">Predio guardado exitosamente.</p>');
                setTimeout(() => $('#predio-form p').remove(), 2000);
                $('#predio-form')[0].reset();
                loadData();
            });

            // Manejar el envío del formulario de Técnicos
            $('#tecnico-form').on('submit', function(e) {
                e.preventDefault();
                const tecnicoEmail = $('#tecnico-email').val();
                
                // 1. Crear el nuevo usuario técnico en la simulación de la base de datos de usuarios
                if (users[tecnicoEmail]) {
                    $('#tecnico-form').append('<p style="color:red;">El correo electrónico ya está en uso.</p>');
                    setTimeout(() => $('#tecnico-form p').remove(), 2000);
                    return;
                }
                
                users[tecnicoEmail] = { password: 'password123', role: 'tecnico' };
                
                // 2. Guardar los datos del técnico en la simulación de la base de datos de técnicos
                const newTecnico = {
                    id: $('#tecnico-prof-id').val(),
                    nombre: $('#tecnico-name').val(),
                    tarjeta: $('#tecnico-prof-id').val(),
                    telefono: $('#tecnico-phone').val(),
                    correo: tecnicoEmail
                };
                db.tecnicos.push(newTecnico);

                $('#tecnico-form').append('<p style="color:green;">Técnico guardado y cuenta de usuario creada (Contraseña: password123).</p>');
                setTimeout(() => $('#tecnico-form p').remove(), 3000);
                $('#tecnico-form')[0].reset();
                loadData();
            });
            
            // Manejar el envío del formulario de Inspecciones
            $('#inspeccion-form').on('submit', function(e) {
                e.preventDefault();
                const newInspeccion = {
                    predio: $('#inspeccion-predio').val(),
                    fecha: $('#inspeccion-date').val(),
                    cultivo: $('#inspeccion-cultivo').val(),
                    plantas_totales: parseInt($('#plantas-totales').val()),
                    plantas_afectadas: parseInt($('#plantas-afectadas').val()),
                    plaga: $('#plaga-name').val(),
                    tecnico: 'María Rodríguez' // Simulación de técnico logeado
                };
                db.inspecciones.push(newInspeccion);
                $('#inspeccion-form').append('<p style="color:green;">Inspección registrada exitosamente.</p>');
                setTimeout(() => $('#inspeccion-form p').remove(), 2000);
                $('#inspeccion-form')[0].reset();
                loadData();
            });

            // Manejar la navegación del menú
            $('.main-menu > li > a, .submenu a').on('click', function(e) {
                const target = $(this).data('target');
                if (target) {
                    e.preventDefault();
                    
                    $('.main-menu a').removeClass('active');
                    $(this).addClass('active');
                    
                    $('.content-section').removeClass('active');
                    $('#' + target).addClass('active');
                    
                    $('#page-title').text($(this).text().trim());

                    if ($(window).width() <= 768) {
                        $('.sidebar').toggleClass('active');
                    }
                }
            });

            // Toggle para los submenús
            $('.has-submenu > a').on('click', function(e) {
                e.preventDefault();
                const parentLi = $(this).parent('li');
                parentLi.toggleClass('open');
                parentLi.find('.submenu').slideToggle(300);
            });

            // Toggle para el menú en móviles
            $('.menu-toggle').on('click', function() {
                $('.sidebar').toggleClass('active');
            });

            // Lógica para los filtros en el historial
            $('#filter-predio, #filter-tecnico').on('change', function() {
                const predio = $('#filter-predio').val();
                const tecnico = $('#filter-tecnico').val();
                renderHistorial(predio, tecnico);
            });

            // Lógica para el seguimiento de inspecciones
            $('#seguimiento-predio').on('change', function() {
                const predio = $(this).val();
                if (predio) {
                    $('#seguimiento-content').show();
                    const filteredInspecciones = db.inspecciones.filter(i => i.predio === predio).sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
                    
                    $('#seguimiento-list').empty();
                    const chartData = [];
                    filteredInspecciones.forEach(i => {
                        const incidencia = ((i.plantas_afectadas / i.plantas_totales) * 100).toFixed(2);
                        chartData.push({
                            label: i.fecha,
                            value: parseFloat(incidencia)
                        });
                        const row = `
                            <tr>
                                <td>${i.fecha}</td>
                                <td>${i.cultivo}</td>
                                <td>${i.plantas_totales}</td>
                                <td>${i.plantas_afectadas}</td>
                                <td>${incidencia}%</td>
                            </tr>
                        `;
                        $('#seguimiento-list').append(row);
                    });
                    
                    drawChart(chartData);
                } else {
                    $('#seguimiento-content').hide();
                }
            });
            
            // Función para dibujar el gráfico de barras
            function drawChart(data) {
                const canvas = $('#incidence-chart')[0];
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const margin = 20;
                const chartHeight = canvas.height - margin * 2;
                const chartWidth = canvas.width - margin * 2;
                const barWidth = chartWidth / data.length;
                const maxIncidencia = 100;

                ctx.fillStyle = '#2c5234';
                data.forEach((d, i) => {
                    const barHeight = (d.value / maxIncidencia) * chartHeight;
                    const x = margin + i * barWidth;
                    const y = chartHeight + margin - barHeight;
                    ctx.fillRect(x, y, barWidth - 10, barHeight);
                    
                    // Etiquetas
                    ctx.fillStyle = '#2d3748';
                    ctx.font = '12px Inter';
                    ctx.textAlign = 'center';
                    ctx.fillText(`${d.value}%`, x + barWidth / 2 - 5, y - 5);
                    ctx.fillText(d.label, x + barWidth / 2 - 5, chartHeight + margin + 15);
                });
            }

            // Lógica para generar el reporte
            $('#generate-report-btn').on('click', function() {
                const predio = $('#seguimiento-predio').val();
                if (!predio) {
                    return;
                }
                const filteredInspecciones = db.inspecciones.filter(i => i.predio === predio);

                if (filteredInspecciones.length === 0) {
                    $('#report-content').text('No hay datos para generar el reporte de este predio.');
                    $('#report-modal').show();
                    return;
                }

                const totalInspecciones = filteredInspecciones.length;
                const totalPlantas = filteredInspecciones.reduce((sum, i) => sum + i.plantas_totales, 0);
                const totalAfectadas = filteredInspecciones.reduce((sum, i) => sum + i.plantas_afectadas, 0);
                const promedioIncidencia = ((totalAfectadas / totalPlantas) * 100).toFixed(2);
                
                let reportText = `
                    <h3>Reporte Detallado del Predio: ${predio}</h3>
                    <p><strong>Número de Inspecciones:</strong> ${totalInspecciones}</p>
                    <p><strong>Total de Plantas Inspeccionadas:</strong> ${totalPlantas}</p>
                    <p><strong>Total de Plantas Afectadas:</strong> ${totalAfectadas}</p>
                    <p><strong>Promedio de Incidencia de Plagas:</strong> ${promedioIncidencia}%</p>
                    <br>
                    <h4>Detalle por Inspección:</h4>
                    <ul>
                `;

                filteredInspecciones.forEach(i => {
                    const incidencia = ((i.plantas_afectadas / i.plantas_totales) * 100).toFixed(2);
                    reportText += `<li><strong>Fecha:</strong> ${i.fecha} | <strong>Cultivo:</strong> ${i.cultivo} | <strong>Plaga:</strong> ${i.plaga} | <strong>Incidencia:</strong> ${incidencia}%</li>`;
                });

                reportText += '</ul>';
                
                $('#report-content').html(reportText);
                $('#report-modal').show();
            });

            // Lógica para cerrar el modal de reporte
            $('#close-report-modal').on('click', function() {
                $('#report-modal').hide();
            });

            // Cierra el modal si el usuario hace clic fuera de él
            window.onclick = function(event) {
                if ($(event.target).is('#report-modal')) {
                    $('#report-modal').hide();
                }
            }
        });
    </script>
</body>
</html>
